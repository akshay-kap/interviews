---
layout: default
---

<main>
  <article>
    <h1>Dashboard</h1>
    <button id="create">New Room</button>

    <h2>Call Stats</h2>
    <ul id="rooms"><li><em>Loading old rooms&hellp;</em></li></ul>
    <hr>
    <div id="frame"></div>
    </section>
  </article>
</main>

<script>
  window.API = "{{ site.env['15SECONDLY_API'] }}";

  setupRooms();
  document.getElementById("create").addEventListener("click", newRoom);

  function setupRooms() {
    fetch(window.API + "/rooms", { method: "GET" })
      .then(response => response.json())
      .then(viewRooms);
  }

  function viewRooms(array) {
    const parent = document.getElementById("rooms");
    parent.innerHTML = "";
    for (const [ url, stats ] of array) {
      const li = document.createElement("li");
      li.innerText = url;
      parent.appendChild(li);
    }
  }

  function newRoom() {
    fetch(window.API + "/room", { method: "POST" })
      .then(response => response.json())
      .then(viewFrame)
  }

  function viewFrame(room) {
    const parent = document.getElementById("frame");
    const callFrame = window.DailyIframe.createFrame(parent, {
      url: room.url,
      showLeaveButton: true,
    });
    callFrame.join();
    callFrame.on("loaded", () => setupFrame(parent, callFrame, room));
    callFrame.on("left-meeting", () => cleanupFrame(callFrame));
  }

  function setupFrame(parent, callFrame, room) {
    parent.scrollIntoView({ behavior: "smooth" });
    callFrame.__intervalId = setInterval(() => newStat(callFrame, room), 2000);
  }

  function cleanupFrame(callFrame) {
    callFrame.destroy();
    clearInterval(callFrame.__intervalId);
  }

  function newStat(callFrame, room) {
    callFrame.getNetworkStats().then(stat => fetch(window.API + "/stats", {
      method: "POST",
      body: JSON.stringify({ stat, url: room.url }),
    }));
  }
</script>
