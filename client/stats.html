---
layout: default
---

<style>
  figure {
    overflow: scroll; /* Tufte.js sizes to container, but is not responsive */
  }
</style>

<main>
  {% include back.html %}
  <h1>Stats from <em id="date"></em></h1>
  <p><code>video_recv_bits_per_second</code> / seconds into call</p>
  <figure id="video_recv_bits_per_second"></figure>
  <p><code>video_send_bits_per_second</code> / seconds into call</p>
  <figure id="video_send_bits_per_second"></figure>
  <p><code>video_recv_packet_loss</code> / seconds into call</p>
  <figure id="video_recv_packet_loss"></figure>
  <p><code>video_send_packet_loss</code> / seconds into call</p>
  <figure id="video_send_packet_loss"></figure>
</main>

<script>
  {% include shared.js %}

  /* Get stats for each room
   */
  const params = new URLSearchParams(location.search);
  fetch(window.API + "/rooms/" + params.get("room"))
    .then(response => response.json())
    .then(setupPlots);

  /* Setup our plots
   *
   * In some cases, we may not have enough any data points for a particular
   * stat (if they left the call quickly). In those scenarios, show an error message.
   */
  function setupPlots(room) {
    try {
      if (room && room.stats.length)
        viewPlots(room);
      else
        viewError(document.body);
    } catch {
      viewError(document.body);
    }
  }

  /* View plots with tufte.js
  */
  function viewPlots(room) {
    document.getElementById("date").innerText = timeFormat.forHumans(room.created_at);
    for (const figure of document.querySelectorAll("figure")) {
      new tufte.LinePlot(
        /* Container element ID */
        "#" + figure.id,

        /* Data points: X is time, Y is the current stat */
        room.stats.map(stat => ({
          x: timeFormat.inSeconds(stat.recorded_at) - timeFormat.inSeconds(room.stats[0].recorded_at),
          y: stat[figure.id],
        })),
      );
    }
  }
</script>
