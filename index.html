<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <style>
      body {
        font-size: 16px;
        font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;
      }
      button {
        font-size: 1rem;
      }
    </style>
    <script type="module">
      import { html, define, property, render } from "https://unpkg.com/hybrids@4.1.9/src";

      const data = fetch("data.json").then(x => x.json());

      define("file-table", {
        selected: property(new Set()),
        render: render(
          ({ selected }) => html.resolve(
            data.then(files => html`${[ viewHeader(selected), viewTable(selected, files) ]}`),
            viewLoading()
          ),
          { shadowRoot: false }
        ),
      });

      function viewLoading() {
        return html`<p>Loading...</p>`;
      }

      function viewHeader(selected) {
        return html`
          <header>
            <h1>Selected ${selected.size}</h1>
            <button disabled="${selected.size === 0}">â†¡ Download Selected</button>
          </header>
        `;
      }

      function viewTable(selected, files) {
        return html`
          <table>
            <thead>
              <tr>
                <td></td>
                <td>Name</td>
                <td>Device</td>
                <td>Path</td>
                <td>Status</td>
              </tr>
            </thead>
            <tbody>
              ${files.map(file => viewTableRow(selected, file))}
            </tbody>
          </table>
        `;
      }

      function viewTableRow(selected, file) {
        const available = isAvailable(file);
        const active = selected.has(file.path);
        return html`
          <tr class="${{ "is-available": available, "is-active": active }}"
              onclick="${available && toggle(file)}">
            <td>
              <input
                type="checkbox"
                onchange="${toggle(file)}"
                checked="${active}"
                disabled="${!available}">
            </td>
            <td>${file.name}</td>
            <td>${file.device}</td>
            <td>${file.path}</td>
            <td>${file.status}</td>
          </tr>
        `;
      };

      function toggle(file) {
        return (host, event) => {
          event.preventDefault();
          host.selected = new Set(host.selected); // re-assign to trigger re-render
          host.selected.has(file.path)
            ? host.selected.delete(file.path)
            : host.selected.add(file.path);
        };
      }

      function isAvailable(file) {
        return file.status === "available";
      }
    </script>
  </head>
  <body><file-table></file-table></body>
</html>
